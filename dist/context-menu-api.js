(()=>{var v=Object.defineProperty;var h=(I,e)=>v(I,"name",{value:e,configurable:!0});const p=class p extends CustomModule{constructor(){super({name:"\u{1F4CB} Context Menu API",description:"Custom context menu management for VRCX dialogs",authors:[{name:"Bluscream",description:"VRCX Plugin System Maintainer",userId:"usr_08082729-592d-4098-9a21-83c8dd37a844"}],tags:["API","Core","Context","Library"],dependencies:[]}),this.menuTypes=["user","world","avatar","group","instance"],this.items=new Map,this.menuContainers=new Map,this.processedMenus=new Set,this.debounceTimers=new Map}async load(){this.menuTypes.forEach(e=>{this.items.set(e,new Map)}),this.logger.log("Context Menu API ready"),this.loaded=!0}async start(){const e=new MutationObserver(t=>{this.handleMutations(t)});this.registerObserver(e),e.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","aria-hidden","class"]}),this.enabled=!0,this.started=!0,this.logger.log("Context Menu API started, watching for dialogs"),window.dispatchEvent(new CustomEvent("contextMenuReady",{detail:{contextMenu:this}}))}async onLogin(e){}async stop(){this.logger.log("Stopping Context Menu API"),this.debounceTimers.forEach(e=>clearTimeout(e)),this.debounceTimers.clear(),this.items.forEach(e=>e.clear()),this.processedMenus.clear(),this.menuContainers.clear(),await super.stop()}handleMutations(e){e.forEach(t=>{t.type==="attributes"&&t.target&&this.handleAttributeChange(t.target),t.addedNodes.length&&t.addedNodes.forEach(r=>this.handleAddedNode(r)),t.removedNodes.length&&t.removedNodes.forEach(r=>this.handleRemovedNode(r))})}handleAttributeChange(e){if(e.classList&&e.classList.contains("el-dropdown__popper")&&e.style.display!=="none"&&e.getAttribute("aria-hidden")!=="true"){const r=e.querySelector(".el-dropdown-menu");if(r){const s=r.id||`menu-${Date.now()}`;if(!this.processedMenus.has(s)){const o=this.detectMenuType(r);o&&this.items.get(o).size>0&&this.debouncedMenuDetection(s,o,r)}}}}handleAddedNode(e){if(e.classList&&(e.classList.contains("el-dropdown-menu__item")||e.classList.contains("el-dropdown-item")||e.classList.contains("el-dropdown-menu"))){let t=null,r=null;if(e.classList.contains("el-dropdown-menu")?(t=e,r=e.id||`menu-${Date.now()}`):(t=e.parentElement,r=e.parentElement?.id||`menu-${Date.now()}`),!t||this.processedMenus.has(r))return;const s=this.detectMenuType(t);s&&this.items.get(s).size>0&&this.debouncedMenuDetection(r,s,t)}}handleRemovedNode(e){if(e.classList&&(e.classList.contains("el-dropdown-menu__item")||e.classList.contains("el-dropdown-item")||e.classList.contains("el-dropdown-menu"))){let t=null;e.classList.contains("el-dropdown-menu")?t=e.id:t=e.parentElement?.id,this.processedMenus.has(t)&&(document.contains(e.parentElement)||(this.debounceTimers.has(t)&&(clearTimeout(this.debounceTimers.get(t)),this.debounceTimers.delete(t)),this.processedMenus.delete(t),this.menuContainers.delete(t)))}}debouncedMenuDetection(e,t,r){this.debounceTimers.has(e)&&clearTimeout(this.debounceTimers.get(e));const s=setTimeout(()=>{const o=r.closest(".el-dropdown__popper");o?o.style.display!=="none"&&o.getAttribute("aria-hidden")!=="true"&&this.processMenu(e,t,r):this.processMenu(e,t,r),this.debounceTimers.delete(e)},100);this.debounceTimers.set(e,s)}detectMenuType(e){const r=Array.from(document.querySelectorAll(".el-dropdown__popper")).filter(d=>d.style.display!=="none"&&d.getAttribute("aria-hidden")!=="true").sort((d,u)=>{const c=parseInt(window.getComputedStyle(d).zIndex)||0;return(parseInt(window.getComputedStyle(u).zIndex)||0)-c})[0];if(!r||!r.contains(e))return null;let s=null;const o=r.id;if(o&&(s=document.querySelector(`[aria-controls="${o}"]`)),!s){const d=[...document.querySelectorAll(".x-user-dialog"),...document.querySelectorAll(".x-avatar-dialog"),...document.querySelectorAll(".x-world-dialog"),...document.querySelectorAll(".x-group-dialog")].filter(u=>window.getComputedStyle(u).display!=="none");for(const u of d){const c=u.querySelectorAll("button[aria-controls], button.el-dropdown__caret-button");for(const m of c){const f=m.getBoundingClientRect(),w=r.getBoundingClientRect();if(Math.abs(f.bottom-w.top)<100&&Math.abs(f.left-w.left)<200){s=m;break}}if(s)break}}if(!s)return null;const i=s.closest(".x-user-dialog"),l=s.closest(".x-avatar-dialog"),n=s.closest(".x-world-dialog"),a=s.closest(".x-group-dialog");return i?"user":l?"avatar":n?"world":a?"group":null}processMenu(e,t,r){this.processedMenus.add(e),this.menuContainers.set(e,{menuType:t,container:r});const s=this.items.get(t);!s||s.size===0||s.forEach((o,i)=>{this.addMenuItemToContainer(r,t,i,o)})}addMenuItemToContainer(e,t,r,s){if(e.querySelector(`[data-custom-item-id="${r}"]`))return;const o=document.createElement("li");if(o.className="el-dropdown-menu__item",o.setAttribute("data-custom-item-id",r),o.tabIndex=-1,s.icon){const n=document.createElement("i");n.className=s.icon,n.style.marginRight="8px",o.appendChild(n)}const i=document.createTextNode(s.text);o.appendChild(i);const l=h(()=>{this.handleItemClick(t,r,s)},"clickHandler");this.registerListener(o,"click",l),e.appendChild(o)}handleItemClick(e,t,r){const s=this.getDialogData(e);if(r.onClick&&typeof r.onClick=="function")try{r.onClick(s)}catch(o){this.logger.error(`Error in ${e} menu item ${t}:`,o)}}getDialogData(e){const r={user:".x-user-dialog",avatar:".x-avatar-dialog",world:".x-world-dialog",group:".x-group-dialog"}[e];if(!r)return null;const s=document.querySelectorAll(r);if(!Array.from(s).find(i=>window.getComputedStyle(i).display!=="none"))return null;try{if(e==="user"&&window.$pinia?.user){const i=window.$pinia.user.userDialog;if(i&&i.visible&&i.ref)return i.ref}else if(e==="avatar"&&window.$pinia?.avatar){const i=window.$pinia.avatar.avatarDialog;if(i&&i.visible&&i.ref)return i.ref}else if(e==="world"&&window.$pinia?.world){const i=window.$pinia.world.worldDialog;if(i&&i.visible&&i.ref)return i.ref}else if(e==="group"&&window.$pinia?.group){const i=window.$pinia.group.groupDialog;if(i&&i.visible&&i.ref)return i.ref}}catch(i){this.logger.error("Error extracting dialog data from Pinia:",i)}return null}addUserItem(e,t){return this.addItem("user",e,t)}addAvatarItem(e,t){return this.addItem("avatar",e,t)}addWorldItem(e,t){return this.addItem("world",e,t)}addGroupItem(e,t){return this.addItem("group",e,t)}addInstanceItem(e,t){return this.addItem("instance",e,t)}addItem(e,t,r){return this.menuTypes.includes(e)?!r||!r.text?(this.logger.error("Menu item must have a 'text' property"),!1):(this.items.get(e).set(t,r),this.logger.log(`Added ${e} menu item: ${t}`),!0):(this.logger.error(`Invalid menu type: ${e}`),!1)}removeUserItem(e){return this.removeItem("user",e)}removeAvatarItem(e){return this.removeItem("avatar",e)}removeWorldItem(e){return this.removeItem("world",e)}removeGroupItem(e){return this.removeItem("group",e)}removeInstanceItem(e){return this.removeItem("instance",e)}removeItem(e,t){const r=this.items.get(e);if(r){const s=r.delete(t);return s&&(this.logger.log(`Removed ${e} menu item: ${t}`),this.removeItemFromOpenMenus(t)),s}return!1}removeItemFromOpenMenus(e){this.menuContainers.forEach(({container:t})=>{const r=t.querySelector(`[data-custom-item-id="${e}"]`);r&&r.remove()})}updateUserItem(e,t){return this.updateItem("user",e,t)}updateAvatarItem(e,t){return this.updateItem("avatar",e,t)}updateWorldItem(e,t){return this.updateItem("world",e,t)}updateGroupItem(e,t){return this.updateItem("group",e,t)}updateItem(e,t,r){const o=this.items.get(e)?.get(t);return o?(Object.assign(o,r),this.logger.log(`Updated ${e} menu item: ${t}`),this.updateItemInOpenMenus(e,t,o),!0):(this.logger.warn(`Cannot update ${e} item ${t}: not found`),!1)}updateItemInOpenMenus(e,t,r){this.menuContainers.forEach(({menuType:s,container:o})=>{if(s===e){const i=o.querySelector(`[data-custom-item-id="${t}"]`);if(i){const l=Array.from(i.childNodes).find(a=>a.nodeType===Node.TEXT_NODE);l&&(l.textContent=r.text);const n=i.querySelector("i");if(r.icon)if(n)n.className=r.icon;else{const a=document.createElement("i");a.className=r.icon,a.style.marginRight="8px",i.insertBefore(a,i.firstChild)}else n&&n.remove()}}})}clearUserItems(){return this.clearItems("user")}clearAvatarItems(){return this.clearItems("avatar")}clearWorldItems(){return this.clearItems("world")}clearGroupItems(){return this.clearItems("group")}clearItems(e){const t=this.items.get(e);return t?(t.clear(),this.logger.log(`Cleared all ${e} menu items`),!0):!1}};h(p,"ContextMenuApiPlugin");let g=p;window.customjs.__LAST_PLUGIN_CLASS__=g;})();
