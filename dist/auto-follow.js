(()=>{var I=Object.defineProperty;var p=(f,e)=>I(f,"name",{value:e,configurable:!0});const h=class h extends CustomModule{constructor(){super({name:"Auto Follow \u{1F465}",description:"Automatically sends you invites when followed users join worlds (or requests invites for private instances)",authors:[{name:"Bluscream",description:"VRCX Plugin System Maintainer",userId:"usr_08082729-592d-4098-9a21-83c8dd37a844"}],tags:["Automation","Social"],required_dependencies:["context-menu-api"]}),this.autoFollowUsers=new Map,this.lastRequestedFrom=new Map,this.checkInterval=1e4,this.actionButtons=[{title:"Clear All",color:"warning",icon:"ri-user-unfollow-line",description:"Clear all auto-follow users from the list",callback:async()=>{const e=this.autoFollowUsers.size;if(e===0){this.logger.showInfo("Auto Follow list is already empty");return}await this.showConfirmDialog("Clear Auto Follow List",`Remove all ${e} user(s) from Auto Follow list?`,"Remove All","Cancel")&&this.clearAllAutoFollows()}}]}async load(){this.registerEvent("user-added",{description:"Fired when a user is added to auto-follow list",payload:{userId:"string - User ID",displayName:"string - Display name",timestamp:"number - Unix timestamp"}}),this.registerEvent("user-removed",{description:"Fired when a user is removed from auto-follow list",payload:{userId:"string - User ID",timestamp:"number - Unix timestamp"}}),this.registerEvent("invite-requested",{description:"Fired when an invite request is sent",payload:{userId:"string - User ID",displayName:"string - Display name",success:"boolean - Whether request succeeded",timestamp:"number - Unix timestamp"}});const e=window.customjs.types.SettingType;this.settings=this.defineSettings({useCustomInviteMessage:{type:e.BOOLEAN,description:"Use custom invite messages via invite-message-api (falls back to direct message if unavailable)",default:!0},customInviteRequestMessage:{type:e.STRING,description:"Message template for invite requests when following users",placeholder:"Can I join you?",default:"Can I join you?",variables:{"{userId}":"Target user ID being followed","{userName}":"Target user display name","{userDisplayName}":"Target user display name","{worldName}":"World name they traveled to","{worldId}":"World ID","{instanceId}":"Full instance ID","{myUserId}":"Your user ID","{myUserName}":"Your display name","{myDisplayName}":"Your display name","{now}":"Formatted date/time","{date}":"Current date","{time}":"Current time","{timestamp}":"Unix timestamp","{iso}":"ISO 8601 date/time"}}}),this.logger.log(`\u2699\uFE0F Custom invite message: "${this.settings.store.customInviteRequestMessage}"`),this.logger.log("Auto Follow plugin ready"),this.loaded=!0}async start(){this.utils=window.customjs.utils,this.contextMenuApi=await window.customjs.waitForModule("context-menu-api"),this.setupUserButtons(),this.setupLocationMonitoring(),this.enabled=!0,this.started=!0,this.logger.log("Auto Follow plugin started, location monitoring active")}async onLogin(e){}async stop(){this.logger.log("Stopping Auto Follow plugin");const e=window.customjs?.getModule("context-menu-api");e&&(e.removeUserItem("autoFollow"),e.removeUserItem("clearAutoFollow")),this.autoFollowUsers.clear(),this.lastRequestedFrom.clear(),await super.stop()}setupUserButtons(){try{return this.autoFollowItem&&this.clearAutoFollowItem?!0:this.contextMenuApi?(this.autoFollowItem=this.contextMenuApi.addUserItem("autoFollow",{text:"Auto Follow",icon:"ri-user-follow-line",pluginId:"auto-follow",onClick:e=>this.toggleAutoFollow(e)}),this.clearAutoFollowItem=this.contextMenuApi.addUserItem("clearAutoFollow",{text:"Clear AutoFollow",icon:"ri-user-unfollow-line",pluginId:"auto-follow",onClick:()=>this.clearAllAutoFollows()}),this.logger.log("Auto Follow context menu buttons added"),!0):(this.logger.warn("Context Menu API not available"),!1)}catch(e){const t=e instanceof Error?e.message:String(e);return this.logger.error(`Error setting up Auto Follow buttons: ${t}`),(!this.autoFollowItem||!this.clearAutoFollowItem)&&setTimeout(()=>this.setupUserButtons(),2e3),!1}}setupLocationMonitoring(){const e=this.registerTimer(setInterval(()=>{this.checkFollowedUsersLocations()},this.checkInterval));this.logger.log(`Location monitoring started (interval: ${this.checkInterval}ms)`)}async checkFollowedUsersLocations(){if(this.autoFollowUsers.size!==0)try{for(const[e,t]of this.autoFollowUsers.entries())await this.checkUserLocation(e,t)}catch(e){this.logger.error(`Error checking locations: ${e.message}`)}}async checkUserLocation(e,t){try{const o=await window.request.userRequest.getUser({userId:e});if(!o||!o.json)return;const r=o.json,s=r.location;if(!s||s==="offline"||s==="private")return;t.lastLocation!==s&&(this.logger.log(`User ${r.displayName} moved from ${t.lastLocation||"unknown"} to ${s}`),t.lastLocation=s,t.user=r,this.autoFollowUsers.set(e,t),this.lastRequestedFrom.get(e)!==s&&await this.requestInviteToUser(r,s))}catch(o){this.logger.warn(`Failed to check location for user ${e}: ${o.message}`)}}async requestInviteToUser(e,t){const o=e.displayName,r=window.$pinia?.user?.currentUser;if(r?.location===t){this.logger.log(`Already in the same instance as ${o}, skipping`);return}const s=window.utils.parseLocation(t);if(s.isTraveling){this.logger.log(`${o} is traveling, waiting for destination...`),this.logger.log("User object while traveling:",e),console.log("User object while traveling:",e);return}if(!s.isRealInstance){this.logger.warn(`Invalid instance location for ${o}: ${t}`);return}let i="Unknown World";try{const a=await window.request.worldRequest.getCachedWorld({worldId:s.worldId});a?.ref?.name?i=a.ref.name:a?.json?.name&&(i=a.json.name)}catch(a){this.logger.warn(`Failed to get world name: ${a.message}`)}const c=s.accessType==="invite"&&!s.canRequestInvite;if(["public","friends","friends+","invite+","group","groupPublic","groupPlus"].includes(s.accessType)||s.accessType==="group"&&s.groupId){const a=window.$pinia?.location,d=a?.lastLocation?.location,g=a?.lastLocationDestination;if(d===t||g===t){this.logger.log("Skipping self-invite - already in or traveling to instance");return}await this.joinGroupIfNeeded(t,o),this.logger.log(`Sending self-invite to join ${o} in "${i}" (${s.accessType})`);try{await window.request.instanceRequest.selfInvite({instanceId:s.instanceId,worldId:s.worldId}),this.lastRequestedFrom.set(e.id,t),this.logger.showSuccess(`Sent self-invite to join ${o} in ${i}`),this.logger.log(`\u2713 Successfully sent self-invite to ${o}`)}catch(l){this.logger.error(`Failed to send self-invite to ${i}: ${l.message}`)}}else if(c||s.accessType==="invite"){const a=window.$pinia?.location,d=a?.lastLocation?.location,g=a?.lastLocationDestination;if(d===t||g===t){this.logger.log("Skipping invite request - already in or traveling to instance");return}await this.joinGroupIfNeeded(t,o),this.logger.log(`Requesting invite from ${o} to private instance "${i}"`);try{const l={instanceId:t,worldId:s.worldId,worldName:i},y=this.settings.store.useCustomInviteMessage!==!1,v=this.settings.store.customInviteRequestMessage||"Can I join you?",m=window.customjs.getModule("invite-message-api"),n=this.processInviteMessageTemplate(v,e,i,t);if(y&&n&&m?.requestInviteRequestMessage){console.log(`Formatted Custom message: ${n}`);try{const u=await m.requestInviteRequestMessage(n);u&&u.message?(l.messageSlot=u.message.slot,this.logger.log(`Using invite request message slot ${u.message.slot} for ${o}`)):this.logger.warn(`Invite request message slot unavailable, sending without message to ${o}`)}catch(u){this.logger.warn(`Failed to use invite-message-api: ${u.message}, sending without message`)}}else n&&!m&&(l.message=n);await window.request.notificationRequest.sendRequestInvite(l,e.id),this.lastRequestedFrom.set(e.id,t),this.logger.showSuccess(`Requested invite from ${o} to ${i}`),this.logger.log(`\u2713 Successfully requested invite from ${o}`),this.emit("invite-requested",{userId:e.id,displayName:e.displayName,success:!0,timestamp:Date.now()}),this.logger.addNotificationLog({id:e.id,displayName:e.displayName,type:"requestInvite",created_at:new Date().toJSON(),message:n,senderUserId:r?.id,senderUsername:r?.displayName,details:{worldId:s.worldId,worldName:i}})}catch(l){this.logger.error(`Failed to request invite from ${o}: ${l.message}`),this.emit("invite-requested",{userId:e.id,displayName:e.displayName,success:!1,timestamp:Date.now()})}}else this.logger.warn(`Unknown instance type "${s.accessType}" for ${o} in ${i}, skipping`)}async joinGroupIfNeeded(e,t){const o=window.utils.parseLocation(e);if(!o.groupId||o.groupAccessType==="public")return!1;try{const r=window.$pinia?.user?.currentUser;if(!r?.id)return!1;const s=await window.request.groupRequest.getGroups({userId:r.id});if(s?.json&&s.json.some(c=>c.id===o.groupId))return!1;try{const i=await window.request.groupRequest.joinGroup({groupId:o.groupId});return i?.json?.membershipStatus==="member"?this.logger.log(`\u2713 Joined group ${o.groupId} to follow ${t}`):i?.json?.membershipStatus==="requested"&&this.logger.log(`\u2713 Sent join request for group ${o.groupId} to follow ${t}`),!0}catch{return!1}}catch{return!1}}processInviteMessageTemplate(e,t,o,r){const s=window.$pinia?.user?.currentUser,i=new Date;return e.replace("{userId}",t.id||"").replace("{userName}",t.displayName||"").replace("{userDisplayName}",t.displayName||"").replace("{worldName}",o||"").replace("{worldId}",r.split(":")[0]||"").replace("{instanceId}",r||"").replace("{myUserId}",s?.id||"").replace("{myUserName}",s?.displayName||"").replace("{myDisplayName}",s?.displayName||"").replace("{now}",this.utils?.formatDateTime?.()||i.toISOString()).replace("{date}",i.toLocaleDateString()).replace("{time}",i.toLocaleTimeString()).replace("{timestamp}",i.getTime().toString()).replace("{iso}",i.toISOString())}toggleAutoFollow(e){if(this.contextMenuApi){if(this.utils.isEmpty(e)){this.logger.showError("Invalid user");return}this.autoFollowUsers.has(e.id)?(this.autoFollowUsers.delete(e.id),this.lastRequestedFrom.delete(e.id),this.logger.log(`Removed ${e.displayName} from Auto Follow list`),this.logger.showInfo(`Removed ${e.displayName} from Auto Follow list`)):(this.autoFollowUsers.set(e.id,{user:e,lastLocation:null}),this.logger.log(`Added ${e.displayName} to Auto Follow list`),this.logger.showSuccess(`Added ${e.displayName} to Auto Follow list`),this.checkUserLocation(e.id,{user:e,lastLocation:null})),this.updateAutoFollowButtonText()}}updateAutoFollowButtonText(){if(this.contextMenuApi)if(this.autoFollowUsers.size===0)this.contextMenuApi.updateUserItem("autoFollow",{text:"Auto Follow",icon:"el-icon-position"});else if(this.autoFollowUsers.size===1){const e=Array.from(this.autoFollowUsers.values())[0];this.contextMenuApi.updateUserItem("autoFollow",{text:`Auto Follow: ${e.user.displayName}`,icon:"el-icon-position"})}else this.contextMenuApi.updateUserItem("autoFollow",{text:`Auto Follow (${this.autoFollowUsers.size} users)`,icon:"el-icon-position"})}clearAllAutoFollows(){if(this.autoFollowUsers.size===0){this.logger.showInfo("Auto Follow list is already empty");return}const e=this.autoFollowUsers.size;this.autoFollowUsers.clear(),this.lastRequestedFrom.clear(),this.logger.log(`Cleared ${e} user(s) from Auto Follow list`),this.logger.showSuccess(`Cleared ${e} user(s) from Auto Follow list`),this.updateAutoFollowButtonText()}getAutoFollowUsers(){return this.autoFollowUsers}getAutoFollowUsersList(){return Array.from(this.autoFollowUsers.values()).map(e=>e.user)}addAutoFollowUser(e){!e||!e.id||(this.autoFollowUsers.set(e.id,{user:e,lastLocation:null}),this.logger.log(`Auto-follow user added: ${e?.displayName}`),this.updateAutoFollowButtonText(),this.emit("user-added",{userId:e.id,displayName:e.displayName,timestamp:Date.now()}),this.checkUserLocation(e.id,{user:e,lastLocation:null}))}removeAutoFollowUser(e){if(this.autoFollowUsers.has(e)){const t=this.autoFollowUsers.get(e);this.autoFollowUsers.delete(e),this.lastRequestedFrom.delete(e),this.logger.log(`Auto-follow user removed: ${t?.user?.displayName}`),this.updateAutoFollowButtonText(),this.emit("user-removed",{userId:e,timestamp:Date.now()})}}clearAutoFollowUsers(){this.clearAllAutoFollows()}getcustomInviteRequestMessage(){return this.settings.store.customInviteRequestMessage}async setcustomInviteRequestMessage(e){this.settings.store.customInviteRequestMessage=e||"Can I join you?",e===null?this.logger.log("Custom invite message disabled"):this.logger.log(`Custom invite message updated: "${e}"`)}setCheckInterval(e){e<5e3&&(this.logger.warn("Interval too short, setting to minimum 5000ms"),e=5e3),this.checkInterval=e,this.logger.log(`Check interval updated to ${e}ms`),this.started&&this.logger.log("Restarting location monitoring with new interval...")}};p(h,"AutoFollowPlugin");let w=h;window.customjs.__LAST_PLUGIN_CLASS__=w;})();
