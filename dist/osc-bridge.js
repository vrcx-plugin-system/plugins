(()=>{var h=Object.defineProperty;var d=(g,l)=>h(g,"name",{value:l,configurable:!0});const c=class c extends CustomModule{constructor(){super({name:"OSC Bridge \u{1F39B}\uFE0F",description:"Bridges VRCX with external OSC application for VRChat OSC communication",authors:[{name:"Bluscream",description:"VRCX Plugin System Maintainer",userId:"usr_08082729-592d-4098-9a21-83c8dd37a844"}],tags:["Integration","OSC","VRChat"],required_dependencies:[]});this.pendingCommands=new Map;this.oscReady=!1,this.pendingMessages=[],this.stats={messagesSent:0,messagesReceived:0,errors:0,lastSent:null,lastReceived:null},this.actionButtons=[{title:"Test Connection",color:"primary",icon:"ri-signal-tower-line",description:"Send test ping to OSC application",callback:async()=>{this.sendChatBox("VRCX Plugin Test"),this.logger.showInfo("Test message sent to OSC app")}},{title:"Reset Stats",color:"warning",icon:"ri-refresh-line",description:"Reset statistics",callback:async()=>{this.stats.messagesSent=0,this.stats.messagesReceived=0,this.stats.errors=0,this.logger.showSuccess("Statistics reset")}}]}async load(){this.registerEvent("osc-param-changed",{description:"Fired when VRChat OSC parameter changes",payload:{path:'string - OSC parameter path (e.g., "/avatar/parameters/VRChatting")',type:"string - Value type (bool, int, float)",value:"any - Parameter value",timestamp:"number - Unix timestamp"},broadcastIPC:!1,logToConsole:!1}),this.registerEvent("osc-ready",{description:"Fired when OSC bridge is connected",payload:{timestamp:"number - Unix timestamp"},broadcastIPC:!1,logToConsole:!1}),this.registerEvent("osc-error",{description:"Fired when OSC error occurs",payload:{error:"string - Error message",timestamp:"number - Unix timestamp"},broadcastIPC:!1,logToConsole:!1}),this.registerEvent("command-received",{description:"Fired when VRCOSC sends a command to VRCX",payload:{command:"string - Command name",args:"any - Command arguments",timestamp:"number - Unix timestamp"},broadcastIPC:!1,logToConsole:!0});const s=window.customjs.types.SettingType;this.categories=this.defineSettingsCategories({connection:{name:"\u{1F39B}\uFE0F Connection",description:"OSC connection settings"},chatbox:{name:"\u{1F4AC} ChatBox",description:"VRChat ChatBox integration (deprecated methods)"},variables:{name:"\u{1F4DD} Variables",description:"ChatBox variable storage (recommended)"},advanced:{name:"\u{1F39B}\uFE0F Advanced",description:"Advanced OSC settings"}}),this.settings=this.defineSettings({enabled:{type:s.BOOLEAN,description:"Enable OSC bridge",category:"connection",default:!0},autoReconnect:{type:s.BOOLEAN,description:"Auto-reconnect to OSC app if disconnected",category:"connection",default:!0},ipcMessageType:{type:s.STRING,description:"IPC message type for bulk events (Event7List=silent, VrcxMessage=verbose)",category:"advanced",default:"Event7List"},logOscParams:{type:s.BOOLEAN,description:"Log all OSC parameter changes to console",category:"advanced",default:!1},logCommands:{type:s.BOOLEAN,description:"Log VRCOSC commands to console",category:"advanced",default:!0},enableDirectChatBox:{type:s.BOOLEAN,description:"\u26A0\uFE0F Enable deprecated direct ChatBox methods (sendChatBox/clearChatBox). Use storeChatVariable() instead.",category:"chatbox",default:!1}}),this.setupIpcListener(),this.patchIpcLogging(),this.loaded=!0,this.logger.log("OSC Bridge plugin loaded")}async start(){this.oscReady=!1,this.pendingMessages=[],this.sendIpcToOSC("INIT",{timestamp:Date.now()}),this.logger.log("Waiting for VRCOSC to connect...")}async stop(){this.sendIpcToOSC("SHUTDOWN",{timestamp:Date.now()}),await super.stop(),this.logger.log("OSC Bridge stopped")}setupIpcListener(){this.onIpc(s=>{if(s.type?.startsWith("OSC_"))this.handleIpcMessage(s);else{const t=this.settings?.store?.ipcMessageType||"Event7List";s.type===t&&s.raw?.MsgType==="OSC_RECEIVED_BULK"&&this.handleIpcMessage({type:s.raw.MsgType,payload:JSON.parse(s.raw.Data)})}}),this.logger.log("IPC listener registered for OSC messages")}patchIpcLogging(){const s=console.log,t=this;console.log=function(...e){if(e.length>=2&&e[0]==="IPC:"&&typeof e[1]=="object"){const a=e[1],r=t.settings?.store?.ipcMessageType||"Event7List";if(a?.Type===r&&a?.MsgType==="OSC_RECEIVED_BULK"&&!t.settings?.store?.logOscParams)return}s.apply(console,e)},this.logger.log("IPC logging filter installed")}handleIpcMessage(s){try{switch(s.type){case"OSC_READY":this.oscReady=!0,this.logger.showSuccess("OSC application connected!"),this.emit("osc-ready",{timestamp:Date.now()}),this.pendingMessages.length>0&&(this.logger.log(`Sending ${this.pendingMessages.length} pending messages`),this.pendingMessages.forEach(a=>this.sendIpcToOSC("SEND",a)),this.pendingMessages=[]);break;case"OSC_RECEIVED":this.settings.store.logOscParams&&this.logger.log(`OSC \u2190 VRChat: ${s.payload.address} = ${JSON.stringify(s.payload.value)} (${s.payload.type})`),this.emit("osc-param-changed",{path:s.payload.address,type:s.payload.type,value:s.payload.value,timestamp:Date.now()});break;case"OSC_RECEIVED_BULK":const t=s.payload.events;if(Array.isArray(t)){this.settings.store.logOscParams&&this.logger.log(`OSC \u2190 VRChat: Received ${t.length} bulk events`);for(const a of t)this.settings.store.logOscParams&&this.logger.log(`  ${a.Address} = ${JSON.stringify(a.Value)} (${a.Type})`),this.emit("osc-param-changed",{path:a.Address,type:a.Type,value:a.Value,timestamp:a.Timestamp||Date.now()});this.stats.messagesReceived+=t.length,this.stats.lastReceived=Date.now()}break;case"OSC_COMMAND":this.settings.store.logCommands&&this.logger.log(`Command \u2190 VRCOSC: ${s.payload.command}`),this.handleCommand(s.payload);break;case"OSC_RESPONSE":const e=s.payload.requestId;if(e&&this.pendingCommands.has(e)){const a=this.pendingCommands.get(e);clearTimeout(a.timeout),a.resolve(s.payload.result),this.pendingCommands.delete(e)}break;case"OSC_ERROR":this.logger.error(`OSC Error: ${s.payload.error}`),this.emit("osc-error",{error:s.payload.error,timestamp:Date.now()});break;case"OSC_DISCONNECTED":this.oscReady=!1,this.logger.showWarning("OSC application disconnected"),this.settings.store.autoReconnect&&setTimeout(()=>{this.sendIpcToOSC("INIT",{timestamp:Date.now()})},5e3);break;default:this.logger.warn(`Unknown OSC IPC message: ${s.type}`)}}catch(t){const e=t instanceof Error?t.message:String(t);this.logger.error(`Error handling IPC message: ${e}`)}}async handleCommand(s){const{command:t,args:e,requestId:a}=s;let r={success:!1,error:"Unknown command"};try{switch(this.logger.log(`Command from VRCOSC: ${t}`,e),this.emit("command-received",{command:t,args:e,timestamp:Date.now()}),t){case"SEND_INVITE":r=await this.executeVRChatInvite(e);break;case"SEND_FRIEND_REQUEST":r=await this.executeVRChatFriendRequest(e);break;case"GET_USER_INFO":r=await this.executeGetUserInfo(e);break;case"GET_WORLD_INFO":r=await this.executeGetWorldInfo(e);break;case"GET_CURRENT_LOCATION":r=this.executeGetCurrentLocation();break;case"GET_FRIENDS_LIST":r=this.executeGetFriendsList(e);break;case"SHOW_NOTIFICATION":r=this.executeShowNotification(e);break;case"SHOW_TOAST":r=this.executeShowToast(e);break;case"OPEN_USER_DIALOG":r=this.executeOpenUserDialog(e);break;case"OPEN_WORLD_DIALOG":r=this.executeOpenWorldDialog(e);break;case"GET_PLUGIN_LIST":r=this.executeGetPluginList();break;case"GET_ONLINE_FRIENDS":r=this.executeGetOnlineFriends();break;case"QUERY_DATABASE":r=await this.executeQueryDatabase(e);break;default:r={success:!1,error:`Unknown command: ${t}`}}}catch(n){const i=n instanceof Error?n.message:String(n);r={success:!1,error:i},this.logger.error(`Command execution failed: ${i}`)}a&&this.sendIpcToOSC("RESPONSE",{requestId:a,result:r})}async executeVRChatInvite(s){const{userId:t,instanceId:e,worldId:a,worldName:r,message:n}=s,i={instanceId:e,worldId:a,worldName:r};return n&&(i.message=n),await window.request.notificationRequest.sendInvite(i,t),{success:!0,message:`Invite sent to ${t}`}}async executeVRChatFriendRequest(s){const{userId:t}=s;return await window.request.friendRequest.sendFriendRequest(t),{success:!0,message:`Friend request sent to ${t}`}}async executeGetUserInfo(s){const{userId:t}=s;return{success:!0,data:await window.request.apiRequest.getUser(t)}}async executeGetWorldInfo(s){const{worldId:t}=s;return{success:!0,data:await window.request.apiRequest.getWorld(t)}}executeGetCurrentLocation(){const s=window.$pinia?.user?.currentUser;return{success:!0,data:{userId:s?.id,displayName:s?.displayName,location:s?.location,worldId:window.$pinia?.location?.worldId,instanceId:window.$pinia?.location?.instanceId}}}executeGetFriendsList(s){const{onlineOnly:t=!1}=s||{},e=window.$pinia?.friends?.friends||[];return{success:!0,data:(t?e.filter(r=>r.location&&r.location!=="offline"&&r.location!=="private"):e).map(r=>({id:r.id,displayName:r.displayName,location:r.location,status:r.status,statusDescription:r.statusDescription}))}}executeShowNotification(s){const{title:t,message:e,type:a="info"}=s,r=window.AppApi;return r?.DesktopNotification&&r.DesktopNotification(t,e),{success:!0}}executeShowToast(s){const{message:t,type:e="info"}=s;switch(e){case"success":this.logger.showSuccess(t);break;case"warning":this.logger.showWarning(t);break;case"error":this.logger.showError(t);break;default:this.logger.showInfo(t);break}return{success:!0}}executeOpenUserDialog(s){const{userId:t}=s,e=window.$pinia?.user;return e?.showUserDialog?(e.showUserDialog(t),{success:!0}):{success:!1,error:"User dialog not available"}}executeOpenWorldDialog(s){const{worldId:t}=s,e=window.$pinia?.world;return e?.showWorldDialog?(e.showWorldDialog(t),{success:!0}):{success:!1,error:"World dialog not available"}}executeGetPluginList(){return{success:!0,data:(window.customjs?.modules||[]).map(t=>({id:t.metadata.id,name:t.metadata.name,enabled:t.enabled,started:t.started}))}}executeGetOnlineFriends(){const t=(window.$pinia?.friends?.friends||[]).filter(e=>e.location&&e.location!=="offline"&&e.location!=="private");return{success:!0,count:t.length,data:t.map(e=>({id:e.id,displayName:e.displayName,location:e.location,worldId:e.worldId}))}}async executeQueryDatabase(s){const{query:t,params:e=[]}=s;try{const a=window.SQLite;return a?{success:!0,data:await a.Execute(t,e)}:{success:!1,error:"SQLite not available"}}catch(a){return{success:!1,error:a instanceof Error?a.message:String(a)}}}sendIpcToOSC(s,t){try{const e=window.AppApi;return e?.SendIpc?(e.SendIpc(`OSC_${s}`,JSON.stringify(t)),!0):(this.logger.error("AppApi.SendIpc not available"),!1)}catch(e){const a=e instanceof Error?e.message:String(e);return this.logger.error(`Failed to send IPC: ${a}`),!1}}sendOSC(s,t){if(!this.settings.store.enabled)return this.logger.warn("OSC Bridge is disabled"),!1;const e={address:s,value:t,timestamp:Date.now()};if(!this.oscReady)return this.pendingMessages.push(e),this.logger.log(`OSC app not ready, message queued (${this.pendingMessages.length} pending)`),!1;const a=this.sendIpcToOSC("SEND",e);return a&&(this.stats.messagesSent++,this.stats.lastSent=Date.now(),this.settings.store.logOscParams&&this.logger.log(`OSC \u2192 VRChat: ${s} = ${JSON.stringify(t)}`)),a}sendChatBox(s,t=!0){if(!this.settings.store.enableDirectChatBox)return this.logger.showWarning("Direct ChatBox methods are disabled. Use storeChatVariable() or enable in settings."),this.logger.warn("\u26A0\uFE0F sendChatBox() is deprecated. Use storeChatVariable() + ChatBox timeline for proper integration."),!1;this.logger.warn("\u26A0\uFE0F Using deprecated sendChatBox(). Consider using storeChatVariable() + ChatBox timeline instead.");const e=this.settings.store.chatboxPrefix||"",a=this.settings.store.chatboxSuffix||"",n=(e+s+a).substring(0,144);return this.sendOSC("/chatbox/input",[n,t,!1])}clearChatBox(){return this.settings.store.enableDirectChatBox?(this.logger.warn("\u26A0\uFE0F Using deprecated clearChatBox(). Consider using storeChatVariable('', '') instead."),this.sendOSC("/chatbox/input",["",!0,!1])):(this.logger.showWarning("Direct ChatBox methods are disabled. Use storeChatVariable('', '') or enable in settings."),this.logger.warn("\u26A0\uFE0F clearChatBox() is deprecated. Use storeChatVariable() + ChatBox timeline instead."),!1)}setAvatarParameter(s,t){return this.sendOSC(`/avatar/parameters/${s}`,t)}getStats(){return{oscReady:this.oscReady,messagesSent:this.stats.messagesSent,messagesReceived:this.stats.messagesReceived,errors:this.stats.errors,lastSent:this.stats.lastSent,lastReceived:this.stats.lastReceived,pendingMessages:this.pendingMessages.length}}async fetchChatVariable(s){if(!this.oscReady)return this.logger.warn("OSC app not ready"),null;try{const t=this.generateRequestId(),e=await this.sendCommandToOSC("GET_VARIABLE",{name:s},t);return e?.success?e.value:(this.logger.warn(`Variable '${s}' not found: ${e?.error||"Unknown error"}`),null)}catch(t){const e=t instanceof Error?t.message:String(t);return this.logger.error(`Failed to fetch variable '${s}': ${e}`),null}}async storeChatVariable(s,t){if(!this.oscReady)return this.logger.warn("OSC app not ready - variable will be queued"),!1;try{const e=this.generateRequestId(),a=await this.sendCommandToOSC("SET_VARIABLE",{name:s,value:t},e);return a?.success?(this.settings.store.logCommands&&this.logger.log(`\u2713 ChatBox variable 'vrcx_${s}' stored: ${JSON.stringify(t)}`),!0):(this.logger.error(`Failed to store variable '${s}': ${a?.error||"Unknown error"}`),!1)}catch(e){const a=e instanceof Error?e.message:String(e);return this.logger.error(`Failed to store variable '${s}': ${a}`),!1}}generateRequestId(){return`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async sendCommandToOSC(s,t,e){return new Promise((a,r)=>{const n=setTimeout(()=>{this.pendingCommands.delete(e),r(new Error("Command timeout"))},5e3);this.pendingCommands.set(e,{resolve:a,reject:r,timeout:n}),this.sendIpcToOSC("COMMAND",{command:s,args:t,requestId:e})})}};d(c,"OSCBridgePlugin");let o=c;window.customjs.__LAST_PLUGIN_CLASS__=o;})();
