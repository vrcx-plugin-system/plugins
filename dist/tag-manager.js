(()=>{var m=Object.defineProperty;var u=(p,e)=>m(p,"name",{value:e,configurable:!0});const f=class f extends CustomModule{constructor(){super({name:"Tag Manager \u{1F3F7}\uFE0F",description:"Custom user tags management with URL-based loading",authors:[{name:"Bluscream",description:"VRCX Plugin System Maintainer",userId:"usr_08082729-592d-4098-9a21-83c8dd37a844"}],tags:["Social","Enhancement"],required_dependencies:["tag-api"]}),this.loadedTags=new Map,this.actionButtons=[{title:"Refresh Tags",color:"success",icon:"ri-refresh-line",description:"Reload tags from all configured URLs",callback:async()=>{this.logger.showInfo("Refreshing tags from URLs..."),await this.refreshTags();const e=this.getLoadedTagsCount();this.logger.showSuccess(`Loaded ${e} tags successfully!`)}},{title:"Find Tagged Users",color:"primary",icon:"ri-search-line",description:"Search all stores for tagged users and print to console",callback:async()=>{this.logger.showInfo("Searching for tagged users...");const e=await this.findTaggedUsers(!0),s=Object.values(e).reduce((t,o)=>t+Object.keys(o).length,0);this.logger.showSuccess(`Found ${s} tagged users (see console for details)`)}}]}async load(){this.registerEvent("tags-loaded",{description:"Fired when tags are successfully loaded from URLs",payload:{totalTags:"number - Total number of tags loaded",sources:"number - Number of sources loaded from",timestamp:"number - Unix timestamp"}}),this.registerEvent("tags-applied",{description:"Fired when tags are applied to users in UI",payload:{userId:"string - User ID",tags:"array - Array of tag names applied",timestamp:"number - Unix timestamp"},broadcastIPC:!1,logToConsole:!1}),this.registerEvent("tagged-player-join",{description:"Fired when a tagged player joins your instance",payload:{userId:"string - User ID",displayName:"string - Display name",tags:"array - Array of tag names",timestamp:"number - Unix timestamp"}});const e=window.customjs.types.SettingType;this.categories=this.defineSettingsCategories({general:{name:"\u{1F3F7}\uFE0F Tag Sources",description:"Configure tag loading sources"},worlds:{name:"\u{1F30D} World Tags",description:"Configure world blacklist/tag sources"},timing:{name:"\u{1F3F7}\uFE0F Update Timing",description:"Control when and how often tags are refreshed"},notifications:{name:"\u{1F3F7}\uFE0F Notifications",description:"Configure notifications for tagged players"}}),this.settings=this.defineSettings({urls_user:{type:e.CUSTOM,description:"URLs to load user tags from",category:"general",default:["https://github.com/Bluscream/FewTags/raw/refs/heads/main/usertags.json"]},urls_worlds:{type:e.CUSTOM,description:"URLs to load world blacklists from",category:"worlds",default:["https://github.com/cyberkitsune/chatbox-club-blacklist/raw/refs/heads/master/npblacklist.json"]},worldTagText:{type:e.STRING,description:"Tag text for blacklisted worlds",category:"worlds",default:"ChatBox Blacklisted"},worldTagColor:{type:e.STRING,description:"Tag color for blacklisted worlds (hex)",category:"worlds",default:"#FF0000"},updateInterval:{type:e.TIMESPAN,description:"How often to reload tags",category:"timing",default:36e5},initialDelay:{type:e.TIMESPAN,description:"Delay before first tag load after login",category:"timing",default:5e3},notifyOnPlayerJoin:{type:e.BOOLEAN,description:"Show notification when a tagged player joins your instance",category:"notifications",default:!0}}),this.logger.log(`\u2699\uFE0F Configured user tag sources: ${this.settings.store.urls_user.length}`),this.logger.log(`\u2699\uFE0F Configured world tag sources: ${this.settings.store.urls_worlds.length}`),this.logger.log("Tag Manager plugin ready"),this.loaded=!0}async start(){this.setupPlayerJoinMonitoring(),this.enabled=!0,this.started=!0,this.logger.log("Tag Manager plugin started (waiting for login to load tags)")}async onLogin(e){this.logger.log(`User logged in: ${e?.displayName}`);const s=this.settings.store.initialDelay;setTimeout(async()=>{await this.loadAllTags(),this.startPeriodicUpdates();try{const o=`VRCX Custom Tags loaded at ${this.utils?.getTimestamp()||new Date().toISOString()}`;this.logger.log(o,{console:!0,vrcx:{message:!0}},"info")}catch{this.logger.log(`Tags loaded at ${new Date().toISOString()}`)}},s),this.logger.log(`Tag loading scheduled (delay: ${s}ms)`)}async stop(){this.logger.log("Stopping Tag Manager"),this.loadedTags.clear(),await super.stop()}async loadAllTags(){const e=this.settings.store.urls_user||[],s=this.settings.store.urls_worlds||[],t=e.length+s.length;if(t===0){this.logger.warn("No tag URLs configured");return}this.logger.log(`Loading tags from ${t} URLs...`);for(const a of e)try{await this.loadTagsFromUrl(a,"user")}catch(n){const r=n instanceof Error?n.message:String(n);this.logger.error(`Failed to load user tags from ${a}: ${r}`)}for(const a of s)try{await this.loadTagsFromUrl(a,"world")}catch(n){const r=n instanceof Error?n.message:String(n);this.logger.error(`Failed to load world tags from ${a}: ${r}`)}const o=this.getLoadedTagsCount();this.logger.log(`\u2713 Tag loading complete (${o} tags loaded)`),this.emit("tags-loaded",{totalTags:o,sources:t,timestamp:Date.now()})}async loadTagsFromUrl(e,s="user"){try{this.logger.log(`Fetching ${s} tags from: ${e}`);const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const o=await t.json();let a;s==="world"?a=this.parseWorldData(o,e):a=this.parseTagData(o,e),a.length>0?(this.loadedTags.set(e,new Set(a)),s==="world"?await this.applyWorldTags(a):await this.applyTags(a),this.logger.log(`\u2713 Loaded ${a.length} ${s} tags from ${e}`)):this.logger.warn(`No valid ${s} tags found in ${e}`)}catch(t){const o=t instanceof Error?t.message:String(t);throw this.logger.error(`Error loading ${s} tags from ${e}: ${o}`),t}}parseTagData(e,s){const t=[];if(typeof e=="object"&&!Array.isArray(e)){for(const[o,a]of Object.entries(e))if(a&&a.tags&&Array.isArray(a.tags)){for(const n of a.tags)if(typeof n=="string"){const r=n.match(/<color=(#[0-9A-Fa-f]{6})>(.*?)<\/color>/);let i=n,g=a.foreground_color||"#FF00C6";r?(g=r[1],i=r[2]):i=n.replace(/<[^>]*>/g,""),t.push({UserId:o,Tag:this.cleanTagText(i),TagColour:g})}}}else if(Array.isArray(e))t.push(...e);else if(e.tags&&Array.isArray(e.tags))t.push(...e.tags);else if(e.data&&Array.isArray(e.data))t.push(...e.data);else return this.logger.warn(`Unknown data structure in ${s}`),[];return t.filter(o=>this.validateTag(o,s))}parseWorldData(e,s){const t=[];if(e.worlds&&Array.isArray(e.worlds)){const o=this.settings.store.worldTagText||"ChatBox Blacklisted",a=this.settings.store.worldTagColor||"#FF0000";for(const n of e.worlds)n.id&&n.id.startsWith("wrld_")&&t.push({WorldId:n.id,WorldName:n.name||n.id,Tag:o,TagColour:a,Comment:n.comment||""})}else if(Array.isArray(e)){const o=this.settings.store.worldTagText||"ChatBox Blacklisted",a=this.settings.store.worldTagColor||"#FF0000";for(const n of e)n.id&&n.id.startsWith("wrld_")&&t.push({WorldId:n.id,WorldName:n.name||n.id,Tag:o,TagColour:a,Comment:n.comment||""})}else return this.logger.warn(`Unknown world data structure in ${s}`),[];return t.filter(o=>this.validateWorldTag(o))}validateWorldTag(e){return!(!e||typeof e!="object"||!e.WorldId||typeof e.WorldId!="string"||!e.WorldId.startsWith("wrld_")||!e.Tag||typeof e.Tag!="string")}cleanTagText(e){return typeof e!="string"?"Custom Tag":e.replace(/<color=#[^>]*>/g,"").replace(/<\/color>/g,"").replace(/\*\*/g,"").replace(/\*/g,"").replace(/_/g,"").trim()}validateTag(e,s){return!e||typeof e!="object"||!e.UserId||typeof e.UserId!="string"||!e.Tag||typeof e.Tag!="string"?!1:(e.TagColour||(e.TagColour="#FF00C6"),!0)}async applyTags(e){const s=window.customjs.getModule("tag-api");if(!s||!s.addUserTag){this.logger.error("Tag API module not found or addUserTag method missing - falling back to userStore");const t=window.$pinia?.user;if(!t){this.logger.warn("User store not available, cannot apply tags");return}for(const o of e)try{t.addCustomTag({UserId:o.UserId,Tag:o.Tag,TagColour:o.TagColour})}catch(a){const n=a instanceof Error?a.message:String(a);this.logger.error(`Error applying tag for user ${o.UserId}: ${n}`)}}else{for(const t of e)try{const o=t.Url||"",a=t.Tooltip||t.Comment||"";s.addUserTag(t.UserId,t.Tag,t.TagColour,o,a)}catch(o){const a=o instanceof Error?o.message:String(o);this.logger.error(`Error applying tag for user ${t.UserId}: ${a}`)}this.logger.log(`Applied ${e.length} user tags via Tag API`)}await this.checkFriendsAndBlockedForTags()}async applyWorldTags(e){const s=window.customjs.getModule("tag-api");if(!s||!s.addWorldTag){this.logger.error("Tag API module not found or addWorldTag method missing - world tags disabled");return}for(const t of e)try{const o=t.Url||"",a=t.Tooltip||t.Comment||"";s.addWorldTag(t.WorldId,t.Tag,t.TagColour,o,a)}catch(o){const a=o instanceof Error?o.message:String(o);this.logger.error(`Error applying tag for world ${t.WorldId}: ${a}`)}this.logger.log(`Applied ${e.length} world tags via Tag API`)}async findTaggedUsers(e=!1,s=!1){const t={friends:{},blocked:{},muted:{},hideAvatar:{},interactOff:{},showAvatar:{},interactOn:{},cachedUsers:{},gameLog:{},feed:{},friendLog:{},notificationLog:{}};let o=0;const a=[],n=u((r,i,g,l)=>{try{t[r]||(t[r]={});const d=l?.tag||l?.Tag||"Unknown Tag";t[r][i]=d,o++,a.push({store:r,userId:i,displayName:g||"",tagText:d}),e&&this.logger.log(`[${r}] ${g||i} - ${d}`)}catch{}},"addTaggedUser");try{const r=window.$pinia?.user?.currentUser?.friends||[];for(const i of r){const g=this.getUserTag(i);if(g){const l=this.getFriendName(i);n("friends",i,l,g)}}}catch(r){this.logger.logError("Error checking friends:",r?.message)}try{const r=Array.from(window.$pinia?.moderation?.cachedPlayerModerations?.values()||[]);for(const i of r){const g=this.getUserTag(i.targetUserId);if(g){const l=this.getModerationStoreName(i.type);n(l,i.targetUserId,i.targetDisplayName,g)}}}catch(r){this.logger.logError("Error checking moderations:",r?.message)}try{const r=window.$pinia?.user?.cachedUsers||new Map;for(const[i,g]of r)if(i&&i.startsWith&&i.startsWith("usr_")){const l=this.getUserTag(i);l&&!t.friends[i]&&n("cachedUsers",i,g?.displayName,l)}}catch(r){this.logger.logError("Error checking cached users:",r?.message)}try{const r=window.$pinia?.gameLog?.gameLogTable;if(Array.isArray(r)){const i=new Set;for(const g of r){const l=g.user_id||g.userId;if(l&&l.startsWith("usr_")&&!i.has(l)){const d=this.getUserTag(l);if(d){i.add(l);const c=g.display_name||g.displayName;n("gameLog",l,c,d)}}}}}catch(r){const i=r instanceof Error?r.message:String(r);this.logger.error(`Error checking game log: ${i}`)}try{const r=window.$pinia?.feed?.sharedFeed;if(Array.isArray(r)){const i=new Set;for(const g of r){const l=g.user_id||g.userId;if(l&&l.startsWith("usr_")&&!i.has(l)){const d=this.getUserTag(l);if(d){i.add(l);const c=g.display_name||g.displayName;n("feed",l,c,d)}}}}}catch(r){const i=r instanceof Error?r.message:String(r);this.logger.error(`Error checking feed: ${i}`)}try{const r=window.$pinia?.friend?.friendLog;if(Array.isArray(r)){const i=new Set;for(const g of r){const l=g.user_id||g.userId;if(l&&l.startsWith("usr_")&&!i.has(l)){const d=this.getUserTag(l);if(d){i.add(l);const c=g.display_name||g.displayName;n("friendLog",l,c,d)}}}}}catch(r){const i=r instanceof Error?r.message:String(r);this.logger.error(`Error checking friend log: ${i}`)}try{const r=window.$pinia?.notification?.notificationTable;if(Array.isArray(r)){const i=new Set;for(const g of r){const l=g.sender_user_id||g.senderUserId;if(l&&l.startsWith("usr_")&&!i.has(l)){const d=this.getUserTag(l);if(d){i.add(l);const c=g.sender_username||g.senderUsername;n("notificationLog",l,c,d)}}}}}catch(r){const i=r instanceof Error?r.message:String(r);this.logger.error(`Error checking notification log: ${i}`)}if(s)try{let r=`userId,store,displayName,tagText
`;for(const g of a){const l=[(g.userId||"").replace(/"/g,'""'),(g.store||"").replace(/"/g,'""'),(g.displayName||"").replace(/"/g,'""'),(g.tagText||"").replace(/"/g,'""')].map(d=>`"${d}"`).join(",");r+=l+`
`}await window.customjs.utils.copyToClipboard(r,"Tagged users CSV")?this.logger.showSuccess(`Copied ${a.length} tagged users to clipboard as CSV`):this.logger.showWarning("Failed to copy tagged users to clipboard")}catch{this.logger.showWarning("Failed to copy tagged users to clipboard")}if(e)try{const r=Object.entries(t).filter(([i,g])=>Object.keys(g).length>0).map(([i,g])=>`${i}: ${Object.keys(g).length}`).join(" | ");this.logger.log(`
\u{1F4CA} Tagged Users Summary (${o} total)`),this.logger.log(r)}catch(r){this.logger.logError("Error printing summary:",r?.message)}return t}getModerationStoreName(e){return{block:"blocked",mute:"muted",hideAvatar:"hideAvatar",interactOff:"interactOff",showAvatar:"showAvatar",interactOn:"interactOn"}[e]||"blocked"}async checkFriendsAndBlockedForTags(){await this.findTaggedUsers(!0)}startPeriodicUpdates(){const e=this.settings.store.updateInterval,s=this.registerTimer(setInterval(async()=>{this.logger.log("Periodic tag update triggered"),await this.loadAllTags()},e));this.logger.log(`Periodic updates started (interval: ${e}ms)`)}setupPlayerJoinMonitoring(){this.subscribe("GAMELOG",({gameLogSessionTable:e})=>{if(e?.length>0){const s=e[e.length-1];s?.type==="OnPlayerJoined"&&this.handlePlayerJoin(s)}}),this.logger.log("Player join monitoring registered")}handlePlayerJoin(e){try{if(!this.settings.store.notifyOnPlayerJoin)return;const s=e.userId||e.user_id,t=e.displayName||e.display_name||"Unknown Player";if(!s)return;const o=this.getUserTag(s);if(o){const a=`${t} joined (${o.tag})`;this.logger.log(a,{console:!0,desktop:!0,xsoverlay:!0,ovrtoolkit:!0},"info"),this.emit("tagged-player-join",{userId:s,displayName:t,tags:[o.tag],timestamp:Date.now()})}}catch(s){const t=s instanceof Error?s.message:String(s);this.logger.error(`Error handling player join: ${t}`)}}getUserTag(e){const s=window.customjs.getModule("tag-api");if(s&&s.getUserTags){const a=s.getUserTags(e);if(a&&a.length>0)return a[0]}const t=window.$pinia?.user;if(t&&t.getCustomUserTags){const a=t.getCustomUserTags(e);if(a&&a.length>0)return a[0]}const o=window.$pinia?.user?.customUserTags;return o&&o.size>0&&o.get(e)||null}getFriendName(e){return window.$pinia?.user?.cachedUsers?.get(e)?.displayName||e}async refreshTags(){this.logger.log("Manually refreshing tags..."),await this.loadAllTags()}addTag(e,s,t="#FF00C6",o="",a=""){try{const n=window.customjs.getModule("tag-api");if(n&&n.addUserTag){n.addUserTag(e,s,t,o,a),this.logger.log(`Manually added tag: ${s} for user ${e} via tag-api`);return}const r=window.$pinia?.user;if(!r){this.logger.warn("User store not available, cannot add tag");return}r.addCustomTag({UserId:e,Tag:s,TagColour:t}),this.logger.log(`Manually added tag: ${s} for user ${e}`)}catch(n){const r=n instanceof Error?n.message:String(n);this.logger.error(`Error adding manual tag: ${r}`)}}getLoadedTagsCount(){let e=0;for(const s of this.loadedTags.values())e+=s.size;return e}getActiveTagsCount(){return window.$pinia?.user?.customUserTags?.size||0}getTagsFromUrl(e){return this.loadedTags.get(e)||new Set}};u(f,"TagManagerPlugin");let h=f;window.customjs.__LAST_PLUGIN_CLASS__=h;})();
